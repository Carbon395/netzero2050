<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>äºŒæ°§åŒ–ç¢³æ’æ”¾è¨ˆç®—å™¨</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
<style>
body { font-family: 'Noto Sans TC', sans-serif; margin: 30px; background: #f4f6f8; color:#2c3e50; }
h2 { color: #2c3e50; margin-bottom: 10px;}
.card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 25px;}
.item { margin: 10px 0; }
input, select { padding: 6px 10px; margin-left: 10px; border:1px solid #ccc; border-radius:6px; }
button { margin:5px 5px 0 0; padding: 10px 18px; border:none; border-radius:8px; cursor:pointer; color:#fff; font-weight:bold; background: linear-gradient(45deg,#3498db,#27ae60); transition:0.3s;}
button:hover { filter: brightness(1.1);}
.result { margin-top: 15px; font-size: 18px; font-weight:bold; color:#e74c3c; }
table { margin-top: 15px; border-collapse: collapse; width: 100%; max-width: 720px; background:#fff; border-radius:8px; overflow:hidden;}
table, th, td { border:1px solid #ddd; }
th, td { padding: 10px; text-align: center; }
th { background:#3498db; color:#fff;}
#chart-container, #yearly-chart, #monthlyChartContainer { margin-top: 25px; max-width: 720px; background:#fff; padding:15px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08);}
</style>
</head>
<body>

<h2>äºŒæ°§åŒ–ç¢³æ’æ”¾è¨ˆç®—å™¨</h2>

<div class="card">
  <h3>ğŸ“… è¨­å®šæœŸé–“</h3>
  <div class="item">
    å¹´åº¦
    <select id="year"></select>
  </div>
  <div class="item">
    æœŸé–“
    <select id="startMonth"></select> è‡³
    <select id="endMonth"></select>
  </div>

  <h3>ğŸ’§ è¼¸å…¥ç”¨é‡ (æ¯æœˆ)</h3>
  <div class="item">é›»åŠ› (åº¦) <input type="number" id="electricity" value="0"></div>
  <div class="item">æ°´ (åº¦) <input type="number" id="water" value="0"></div>
  <div class="item">æŸ´æ²¹ (L) <input type="number" id="diesel" value="0"></div>
  <div class="item">è»Šç”¨æ±½æ²¹ (L) <input type="number" id="gasoline" value="0"></div>
  <div class="item">ç‡ƒæ–™æ²¹ (L) <input type="number" id="fuelOil" value="0"></div>
  <div class="item">å¤©ç„¶æ°£ (mÂ³) <input type="number" id="ng" value="0"></div>
  <div class="item">æ¶²åŒ–çŸ³æ²¹æ°£ (L) <input type="number" id="lpg" value="0"></div>

  <button onclick="calculate()">è¨ˆç®—æ’æ”¾é‡</button>
</div>

<div class="card">
  <div class="result" id="result">ç¸½æ’æ”¾é‡ï¼š0 KgCOâ‚‚e</div>

  <table id="details">
    <thead>
      <tr><th>é …ç›®</th><th>ç”¨é‡ (æ¯æœˆ)</th><th>æ’æ”¾é‡ (KgCOâ‚‚e)</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="chart-container">
    <canvas id="emissionChart"></canvas>
  </div>
</div>

<div class="card">
  <h3>ğŸ“Š å¹´åº¦çµ±è¨ˆ</h3>
  <table id="yearlyTable">
    <thead><tr><th>å¹´åº¦</th><th>ç¸½æ’æ”¾é‡ (KgCOâ‚‚e)</th></tr></thead>
    <tbody></tbody>
  </table>
  <div id="yearly-chart">
    <canvas id="yearlyChartCanvas"></canvas>
  </div>
  <div class="item">
    é¸æ“‡å¹´åº¦æŸ¥çœ‹æ¯æœˆæ’æ”¾ï¼š
    <select id="selectYear" onchange="renderMonthlyChart()"></select>
  </div>
  <div id="monthlyChartContainer">
    <canvas id="monthlyChartCanvas"></canvas>
  </div>
  <button onclick="exportYearlyExcel()">åŒ¯å‡º Excel (å¹´åº¦)</button>
  <button onclick="exportYearlyPDF()">åŒ¯å‡º PDF (å¹´åº¦)</button>
</div>

<div class="card">
  <button onclick="exportExcel()">åŒ¯å‡º Excel (æœŸé–“)</button>
  <button onclick="exportPDF()">åŒ¯å‡º PDF (æœŸé–“)</button>
</div>

<script>
// åˆå§‹åŒ–å¹´ä»½åŠæœˆä»½é¸å–®
(function() {
  const yearSelect = document.getElementById("year");
  const selectYear = document.getElementById("selectYear");
  const startMonth = document.getElementById("startMonth");
  const endMonth = document.getElementById("endMonth");
  const currentYear = new Date().getFullYear();
  for(let y=currentYear; y>=currentYear-10; y--){
    let opt=document.createElement("option"); opt.value=y; opt.textContent=y;
    yearSelect.appendChild(opt.cloneNode(true));
    selectYear.appendChild(opt.cloneNode(true));
  }
  yearSelect.value=currentYear;
  selectYear.value=currentYear;

  for(let m=1; m<=12; m++){
    let opt1=document.createElement("option"); opt1.value=m; opt1.textContent=m+" æœˆ";
    let opt2=opt1.cloneNode(true);
    startMonth.appendChild(opt1);
    endMonth.appendChild(opt2);
  }
  startMonth.value=1;
  endMonth.value=12;
})();

// CO2 æ’æ”¾ä¿‚æ•¸
const emissionFactors = {
  electricity: 0.474,
  water: 0.156,
  diesel: 2.606,
  gasoline: 2.263,
  fuelOil: 3.111,
  ng:1.879,
  lpg:1.753
};

let history = []; // ä¿å­˜æ‰€æœ‰è¨ˆç®—ç´€éŒ„

function calculate() {
  const year = parseInt(document.getElementById("year").value);
  const startMonth = parseInt(document.getElementById("startMonth").value);
  const endMonth = parseInt(document.getElementById("endMonth").value);

  const data = {
    electricity: parseFloat(document.getElementById("electricity").value) || 0,
    water: parseFloat(document.getElementById("water").value) || 0,
    diesel: parseFloat(document.getElementById("diesel").value) || 0,
    gasoline: parseFloat(document.getElementById("gasoline").value) || 0,
    fuelOil: parseFloat(document.getElementById("fuelOil").value) || 0,
    ng: parseFloat(document.getElementById("ng").value) || 0,
    lpg: parseFloat(document.getElementById("lpg").value) || 0
  };

  const detailsTbody = document.querySelector("#details tbody");
  detailsTbody.innerHTML = "";
  let monthlyTotal = 0;
  for(let key in data){
    let emission = data[key] * emissionFactors[key];
    monthlyTotal += emission;
    let tr=document.createElement("tr");
    tr.innerHTML=`<td>${key}</td><td>${data[key]}</td><td>${emission.toFixed(2)}</td>`;
    detailsTbody.appendChild(tr);
  }

  const total = monthlyTotal * (endMonth - startMonth + 1);
  document.getElementById("result").textContent = `ç¸½æ’æ”¾é‡ï¼š${total.toFixed(2)} KgCOâ‚‚e`;

  // ä¿å­˜æ­·å²è³‡æ–™ (å¯ç´¯ç©)
  history.push({ year, startMonth, endMonth, data, total });

  updateYearlyData();
  renderChart(data);
  renderMonthlyChart();
}

// å–®æœˆåœ–è¡¨
function renderChart(data) {
  const ctx=document.getElementById("emissionChart").getContext("2d");
  if(window.emissionChart) window.emissionChart.destroy();
  window.emissionChart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:Object.keys(data),
      datasets:[{ label:"æ’æ”¾é‡ KgCOâ‚‚e", data:Object.keys(data).map(k=> (data[k]*emissionFactors[k]).toFixed(2)), backgroundColor:"#3498db"}]
    },
    options:{responsive:true}
  });
}

// å¹´åº¦çµ±è¨ˆ
function updateYearlyData(){
  const yearly = {};
  history.forEach(h=>{
    if(!yearly[h.year]) yearly[h.year]=0;
    yearly[h.year]+=h.total;
  });

  const tbody=document.querySelector("#yearlyTable tbody");
  tbody.innerHTML="";
  Object.keys(yearly).sort().forEach(y=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${y}</td><td>${yearly[y].toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });

  // æ›´æ–°å¹´åº¦ä¸‹æ‹‰
  const selectYear = document.getElementById("selectYear");
  const years = Object.keys(yearly).sort((a,b)=>b-a);
  selectYear.innerHTML="";
  years.forEach(y=>{
    let opt=document.createElement("option"); opt.value=y; opt.textContent=y;
    selectYear.appendChild(opt);
  });
  selectYear.value=years[0];

  // å¹´åº¦åœ–è¡¨
  const ctx=document.getElementById("yearlyChartCanvas").getContext("2d");
  if(window.yearlyChart) window.yearlyChart.destroy();
  window.yearlyChart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:Object.keys(yearly).sort(),
      datasets:[{label:"å¹´åº¦ç¸½æ’æ”¾é‡ KgCOâ‚‚e", data:Object.keys(yearly).sort().map(y=>yearly[y].toFixed(2)), backgroundColor:"#f39c12"}]
    },
    options:{responsive:true}
  });
}

// æ¯æœˆåœ–è¡¨
function renderMonthlyChart(){
  const selectedYear = parseInt(document.getElementById("selectYear").value);
  const monthly = Array(12).fill(0);
  history.filter(h=>h.year==selectedYear).forEach(h=>{
    const monthsCount = h.endMonth - h.startMonth +1;
    for(let m=h.startMonth-1; m<=h.endMonth-1; m++){
      monthly[m] += h.total/monthsCount;
    }
  });

  const ctx=document.getElementById("monthlyChartCanvas").getContext("2d");
  if(window.monthlyChart) window.monthlyChart.destroy();
  window.monthlyChart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"],
      datasets:[{label:selectedYear+"å¹´åº¦æ¯æœˆæ’æ”¾é‡ KgCOâ‚‚e", data:monthly.map(v=>v.toFixed(2)), backgroundColor:"#9b59b6"}]
    },
    options:{responsive:true}
  });
}

// åŒ¯å‡ºæœŸé–“ Excel/PDF
function exportExcel(){
  const wb=XLSX.utils.book_new();
  const ws_data=[["é …ç›®","ç”¨é‡ (æ¯æœˆ)","æ’æ”¾é‡(KgCOâ‚‚e)"]];
  document.querySelectorAll("#details tbody tr").forEach(tr=>{
    ws_data.push(Array.from(tr.children).map(td=>td.textContent));
  });
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"æœŸé–“æ’æ”¾");
  XLSX.writeFile(wb,"CO2æœŸé–“æ’æ”¾.xlsx");
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  doc.text("æœŸé–“ CO2 æ’æ”¾æ˜ç´°",14,20);
  doc.autoTable({html:"#details",startY:30});
  doc.save("CO2æœŸé–“æ’æ”¾.pdf");
}

// åŒ¯å‡ºå¹´åº¦ Excel/PDF
function exportYearlyExcel(){
  const wb=XLSX.utils.book_new();
  const ws_data=[["å¹´åº¦","ç¸½æ’æ”¾é‡(KgCO2e)"]];
  document.querySelectorAll("#yearlyTable tbody tr").forEach(tr=>{
    ws_data.push(Array.from(tr.children).map(td=>td.textContent));
  });
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"å¹´åº¦çµ±è¨ˆ");
  XLSX.writeFile(wb,"CO2å¹´åº¦çµ±è¨ˆ.xlsx");
}

function exportYearlyPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("å¹´åº¦ CO2 æ’æ”¾çµ±è¨ˆ", 14, 20);
  doc.autoTable({ html: "#yearlyTable", startY: 30 });
  doc.save("CO2å¹´åº¦çµ±è¨ˆ.pdf");
}
</script>
</body>
</html>
