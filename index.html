<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>è‡ºåŒ—å¸‚æ—…å®¿æ¥­èƒ½æºå°ç®¡å®¶</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2e7d32">
<style>
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif; margin: 0; background: #eaf5ea; }
h1 { color: #2e7d32; text-align: center; font-size: 1.9rem; font-weight:bold; text-shadow: 1px 1px 2px #ccc; }
h2.page-subtitle { text-align:center; color:#2e7d32; font-size:1rem; margin-bottom:15px; }
#tips { background: #fff9c4; border-left: 6px solid #fbc02d; padding: 12px 15px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); font-size:0.95rem; }
#tips h3 { margin-top: 0; color: #f57f17; font-size:1rem; }
#tips ul { margin: 0; padding-left: 18px; }
.btn { margin: 5px 3px; padding: 8px 18px; background: #2e7d32; color: #fff; border: none; border-radius: 6px; cursor: pointer; transition: 0.2s; font-size: 14px; }
.btn:hover { background: #1b5e20; }
.year-block { margin: 12px; margin-bottom: 35px; padding: 12px; border-radius: 10px; border: 2px solid #c8e6c9; background: #fff; box-shadow: 0 3px 8px rgba(0,0,0,0.1); page-break-inside: avoid; }
.year-block h2 { color: #388e3c; display: inline-block; margin-right: 10px; font-size:1.1rem; }
.year-block input[type="text"], .year-block select { width: 220px; font-size: 0.8rem; margin-right: 5px; }
.year-block input[type="number"] { width:80px; font-size:0.8rem; }
.year-block button { font-size:0.9rem; padding:4px 10px; }
.table-wrapper { overflow-x:auto; margin-top:10px; }
table { border-collapse: collapse; width: 100%; margin-bottom: 15px; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
th, td { border: 1px solid #ddd; padding: 6px; text-align: center; font-size:0.75rem; }
th { background: #388e3c; color: #fff; text-align:center; }
.result { font-weight: bold; color: #000; font-size:0.85rem; }
.red-text { color:#e53935; font-weight:bold; }
.green-text { color:#43a047; font-weight:bold; }
#reduction-chart-container, #energy-chart-container { margin: 12px; margin-top: 30px; padding: 18px; background: #fff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); page-break-inside: avoid; }
#reduction-chart-container h2, #energy-chart-container h2 { text-align:center; color:#2e7d32; margin-bottom:12px; }
#summary h2 { color: #2e7d32; margin-bottom: 12px; font-size:1.1rem; page-break-before:always; }
#globalHotelContainer {
  text-align: center;
  margin: 12px;
  margin-bottom: 15px;
  display: flex;
  flex-wrap: nowrap;
  justify-content: center;
  align-items: center;
}
#globalHotelContainer label {
  flex-grow: 1;
  margin: 0 5px;
}
#globalHotelName, #globalDistrict {
  flex-grow: 1;
  min-width: 80px;
}
#logo-container {
  text-align: center;
  margin-top: 20px;
  margin-bottom: 25px;
}
#logo-container img {
  max-width: 200px;
  height: auto;
}
#intro-page {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #eaf5ea;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 1000;
    text-align: center;
    padding: 10px;
    box-sizing: border-box;
}
#intro-content {
    background: #fff;
    padding: 20px 30px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    max-width: 600px;
    width: 90%;
    max-height: 95vh;
    overflow-y: auto;
}
#intro-content h2 {
    color: #2e7d32;
    font-size: 1.3rem;
    font-weight: bold;
    margin-bottom: 12px;
}
#intro-content p {
    font-size: 0.9rem;
    line-height: 1.5;
    color: #555;
    margin-bottom: 8px;
    text-align: justify;
}
#intro-content ul {
    text-align: left;
    margin-top: 10px;
    margin-bottom: 15px;
    padding-left: 20px;
}
#intro-content ul li {
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 6px;
    color: #333;
}
#intro-btn {
    padding: 10px 25px;
    font-size: 1rem;
    font-weight: bold;
    border-radius: 8px;
    background: #2e7d32;
    color: #fff;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.1s;
    margin-top: 15px;
}
#intro-btn:hover {
    background: #1b5e20;
    transform: translateY(-2px);
}
#main-content {
    display: none;
    padding: 12px;
}
/* é‡å°æ—…é¤¨åç¨±å’Œå¹´åº¦æ¬„ä½çš„æ–°æ¨£å¼ */
.year-header {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
  color: #388e3c;
  font-weight: bold;
  font-size: 1.1rem;
}
.year-header .field-group {
  display: flex;
  align-items: center;
}
.year-header label {
  white-space: nowrap;
}
.year-header input[type="text"],
.year-header input[type="number"] {
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 5px 8px;
  min-width: 100px;
  font-size: 0.9rem;
  width: auto;
}
.year-header .btn {
  margin-left: auto; /* å°‡åˆªé™¤æŒ‰éˆ•æ¨åˆ°å³å´ */
}
@media screen and (max-width:600px){
  h1 { font-size: 1.6rem; }
  .btn { padding:5px 10px; font-size:12px; }
  .table-wrapper { overflow-x:auto; }
  #energy-chart-container canvas, #reduction-chart-container canvas { width:100% !important; height:auto !important; }
  #globalHotelContainer {
    flex-wrap: wrap;
    justify-content: center;
  }
  #globalHotelContainer label {
    flex-basis: 100%;
    margin-bottom: 10px;
  }
  #globalHotelName, #globalDistrict {
    width: 100%;
  }
}
@media print {
  body { background: #fff; margin: 0; font-size: 12pt; }
  .btn, #tips, #globalHotelContainer, #intro-page { display: none; }
  #main-content { display: block; }
  .year-block { page-break-inside: avoid; margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; }
  .table-wrapper { overflow: visible !important; margin-bottom: 15px; }
  table { page-break-inside: avoid; width: 100%; font-size: 10pt; border: 1px solid #000; }
  th, td { border: 1px solid #000; padding: 5px; }
  #reduction-chart-container { page-break-before: always; page-break-after: always; break-inside: avoid; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  #energy-chart-container { break-inside: avoid; page-break-after: always; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  canvas { page-break-inside: avoid; max-width: 100% !important; height: 260px !important; }
  #summary h2 { page-break-before: always; font-size: 14pt; }
  footer { display: block; text-align: center; font-size: 10pt; margin-top: 20px; }
}
</style>
</head>
<body>

<div id="intro-page">
    <div id="intro-content">
        <h2>æœ¬ç¶²ç«™ç›®çš„</h2>
        <p>æœ¬ç¶²ç«™å®—æ—¨ç‚ºå”åŠ©è‡ºåŒ—å¸‚æ—…å®¿æ¥­è€…æœ‰æ•ˆç®¡ç†èƒ½æºä½¿ç”¨ï¼Œä¸¦æŒæ¡å…¶ç”¢ç”Ÿçš„äºŒæ°§åŒ–ç¢³æ’æ”¾é‡ã€‚</p>
        <p>é€éé€™æ¬¾ã€Œèƒ½æºå°ç®¡å®¶ã€ï¼Œæ‚¨å¯ä»¥ï¼š</p>
        <ul>
            <li>è¼•é¬†è¨˜éŒ„ï¼šè¼¸å…¥æ¯æœˆä½¿ç”¨çš„é›»åŠ›ã€æ°´ã€æŸ´æ²¹ã€å¤©ç„¶æ°£ç­‰èƒ½æºæ•¸æ“šã€‚</li>
            <li>å³æ™‚è¨ˆç®—ï¼šç¶²ç«™æœƒè‡ªå‹•è¨ˆç®—æ¯å€‹æœˆåŠæ¯å¹´åº¦çš„ç¸½ç¢³æ’æ”¾é‡ã€‚</li>
            <li>è¦–è¦ºåŒ–å‘ˆç¾ï¼šé€éæ¸…æ™°çš„é•·æ¢åœ–ï¼Œç›´è§€åœ°æ¯”è¼ƒä¸åŒå¹´åº¦çš„ç¸½æ’æ”¾é‡èˆ‡æ¸›ç¢³æˆæœã€‚</li>
            <li>æ•¸æ“šåŒ–ç®¡ç†ï¼šæ‚¨å¯ä»¥è¼•é¬†è¿½è¹¤æ¯é …èƒ½æºçš„å¹´åº¦ä½¿ç”¨è¶¨å‹¢ï¼Œä¸¦ç”Ÿæˆè©³ç´°å ±è¡¨ã€‚</li>
        </ul>
        <p>æœ¬ç¶²ç«™ç”±è‡ºåŒ—å¸‚æ”¿åºœè§€å…‰å‚³æ’­å±€å»ºç½®ï¼Œæä¾›ä¸€å€‹ç°¡å–®ã€å…è²»ä¸”å¯¦ç”¨çš„å·¥å…·ï¼Œé¼“å‹µèˆ‡å¹«åŠ©è‡ºåŒ—å¸‚æ—…å®¿æ¥­è€…è½å¯¦ç¯€èƒ½æ¸›ç¢³ï¼Œç‚ºè‡ºåŒ—å¸‚çš„æ°¸çºŒç™¼å±•ç›¡ä¸€ä»½å¿ƒåŠ›ã€‚</p>
        <button id="intro-btn" onclick="showMainContent()">é–‹å§‹ä½¿ç”¨</button>
    </div>
</div>

<div id="main-content">
  <h1>è‡ºåŒ—å¸‚æ—…å®¿æ¥­èƒ½æºå°ç®¡å®¶</h1>
  <h2 class="page-subtitle">è‡ºåŒ—å¸‚æ”¿åºœè§€å‚³å±€å”åŠ©æ—…å®¿æ¥­è€…ç®¡ç†èƒ½æºä½¿ç”¨èˆ‡æŒæ¡äºŒæ°§åŒ–ç¢³æ’æ”¾é‡</h2>

  <div id="tips">
  <h3>ğŸ’¡ ä½¿ç”¨å°æç¤ºï¼ˆå»ºè­°ä½¿ç”¨æ¡Œå‹æˆ–ç­†è¨˜å‹é›»è…¦ç²å¾—æœ€ä½³ä½¿ç”¨é«”é©—ï¼‰</h3>
  <ul>
  <li>è¼¸å…¥æ—…é¤¨åç¨±èˆ‡é¸æ“‡è¡Œæ”¿å€</li>
  <li>é»æ“Šã€Œâ• æ–°å¢å¹´åº¦ã€ä¾åºå»ºç«‹å¹´åº¦ï¼ˆ2024ã€2025...ï¼‰è¡¨æ ¼</li>
  <li>è¼¸å…¥èƒ½æºï¼ˆé›»åŠ›ã€æ°´ã€æŸ´æ²¹ã€æ±½æ²¹ã€ç‡ƒæ–™æ²¹ã€å¤©ç„¶æ°£ã€æ¶²åŒ–çŸ³æ²¹æ°£ï¼‰ä½¿ç”¨é‡è‡³æ•´æ•¸ä½ç‚ºåŸå‰‡ï¼Œè‹¥æœªä½¿ç”¨è©²èƒ½æºï¼Œè«‹å¡« 0</li>
  <li>ç³»çµ±è‡ªå‹•è¨ˆç®—æ¯æœˆèˆ‡å¹´åº¦ç¸½æ’æ”¾é‡ï¼Œåœ–è¡¨å³æ™‚æ›´æ–°</li>
  <li>ã€ŒğŸ“Š åŒ¯å‡ºæª”æ¡ˆã€å­˜æˆ Excel å ±è¡¨</li>
  <li>â™»ï¸ é‡ç½®è³‡æ–™ã€æ¸…ç©ºæ‰€æœ‰å¹´åº¦èˆ‡åœ–è¡¨</li>
  <li>ã€ŒğŸ–¨ï¸ åˆ—å°å ±è¡¨ã€å¯åˆ—å°å®Œæ•´å¹´åº¦è³‡æ–™èˆ‡åœ–è¡¨</li>
  <li>äºŒæ°§åŒ–ç¢³æ’æ”¾ä¿‚æ•¸ï¼Œåƒè€ƒç¶“æ¿Ÿéƒ¨èƒ½æºç½²ã€è‡ºç£è‡ªä¾†æ°´å…¬å¸ã€ç’°å¢ƒéƒ¨æ°£å€™è®Šé·ç½²å…¬å‘Šæº«å®¤æ°£é«”æ’æ”¾ä¿‚æ•¸20240205å…¬å‘Šç‰ˆ</li>
  </ul>
  </div>

  <div id="globalHotelContainer">
    <label>æ—…é¤¨åç¨±<input type="text" id="globalHotelName" placeholder="è«‹è¼¸å…¥æ—…é¤¨åç¨±" oninput="updateHotelNames()"></label>
    <label>è¡Œæ”¿å€
      <select id="globalDistrict" required>
        <option value="">è«‹é¸æ“‡</option>
        <option value="ä¸­æ­£å€">ä¸­æ­£å€</option>
        <option value="å¤§åŒå€">å¤§åŒå€</option>
        <option value="ä¸­å±±å€">ä¸­å±±å€</option>
        <option value="æ¾å±±å€">æ¾å±±å€</option>
        <option value="å¤§å®‰å€">å¤§å®‰å€</option>
        <option value="è¬è¯å€">è¬è¯å€</option>
        <option value="ä¿¡ç¾©å€">ä¿¡ç¾©å€</option>
        <option value="å£«æ—å€">å£«æ—å€</option>
        <option value="åŒ—æŠ•å€">åŒ—æŠ•å€</option>
        <option value="å…§æ¹–å€">å…§æ¹–å€</option>
        <option value="å—æ¸¯å€">å—æ¸¯å€</option>
        <option value="æ–‡å±±å€">æ–‡å±±å€</option>
      </select>
    </label>
  </div>

  <div style="text-align:center;">
  <button class="btn" onclick="addYear()">â• æ–°å¢å¹´åº¦</button>
  <button class="btn" onclick="exportExcel()">ğŸ“Š åŒ¯å‡ºæª”æ¡ˆ</button>
  <button class="btn" onclick="resetAll()">â™»ï¸ é‡ç½®è³‡æ–™</button>
  <button class="btn" onclick="printReport()">ğŸ–¨ï¸ åˆ—å°å ±è¡¨</button>
  </div>

  <div id="yearContainer"></div>

  <div id="reduction-chart-container">
    <h2>å¹´åº¦æ¸›ç¢³é‡(å…¬å™¸ COâ‚‚e)</h2>
    <canvas id="reductionChart" width="400" height="200"></canvas>
  </div>

  <div id="energy-chart-container">
    <h2>å¹´åº¦èƒ½æºä½¿ç”¨é‡</h2>
    <canvas id="energyChart" width="400" height="200"></canvas>
  </div>

  <div id="summary">
  <h2>ğŸ“‘ å¹´åº¦ç¸½è¦½</h2>
  <div id="ranking"></div>
  <div id="trend"></div>
  <div id="reduction"></div>
  </div>

  <div id="logo-container">
      
  </div>

  <footer>
    Copyright Â© 2025 è‡ºåŒ—å¸‚æ”¿åºœè§€å…‰å‚³æ’­å±€ ç‰ˆæ¬Šæ‰€æœ‰
  </footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
const factors = {"é›»åŠ›(åº¦)":0.474,"æ°´(åº¦)":0.156,"æŸ´æ²¹(å…¬å‡)":2.606,"æ±½æ²¹(å…¬å‡)":2.263,"ç‡ƒæ–™æ²¹(å…¬å‡)":3.111,"å¤©ç„¶æ°£(ç«‹æ–¹å…¬å°º)":1.879,"æ¶²åŒ–çŸ³æ²¹æ°£(å…¬å‡)":1.753};
const months = ["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"];
const baseColors = ["#1e88e5","#43a047","#fbc02d","#e53935","#8e24aa","#fb8c00","#00acc1"];
let reductionChart, energyChart, debounceTimer;

function showMainContent() {
    document.getElementById("intro-page").style.display = "none";
    document.getElementById("main-content").style.display = "block";
}

function updateHotelNames(){
  const name = document.getElementById("globalHotelName").value;
  document.querySelectorAll('.year-block').forEach(block=>{
    const hotelInput = block.querySelector('input[id$="_hotel"]');
    if(hotelInput) hotelInput.value = name;
  });
}

function validateAndCalc(yearId,f,i){
  const el = document.getElementById(`${yearId}_${f}_${i}`);
  let val = parseFloat(el.value); if(isNaN(val)||val<0) val=0; el.value=val;
  clearTimeout(debounceTimer);
  debounceTimer=setTimeout(calcAll,300);
}

function addYear(){
  const yearContainer = document.getElementById("yearContainer");
  const yearCount = yearContainer.children.length + 1;
  const yearId = "year"+yearCount;
  const defaultYear = 2024+yearCount-1;
  const hotelName = document.getElementById("globalHotelName").value||"";
  const district = document.getElementById("globalDistrict").value||"";

  // æ–°å¢å¼·åˆ¶è¼¸å…¥æ—…é¤¨åç¨±çš„æª¢æŸ¥
  if (!hotelName) {
    alert("è«‹å…ˆè¼¸å…¥æ—…é¤¨åç¨±ï¼");
    return;
  }
  if (!district) {
    alert("è«‹å…ˆé¸æ“‡è¡Œæ”¿å€ï¼");
    return;
  }

  let html=`<div class="year-block" id="${yearId}">
  <div class="year-header">
    <div class="field-group">
      <label for="${yearId}_hotel">æ—…é¤¨åç¨±ï¼š</label>
      <input type="text" id="${yearId}_hotel" value="${hotelName}" readonly>
    </div>
    <div class="field-group">
      <label for="${yearId}_district">è¡Œæ”¿å€ï¼š</label>
      <input type="text" id="${yearId}_district" value="${district}" readonly>
    </div>
    <div class="field-group">
      <label for="${yearId}_label">å¹´åº¦ï¼š</label>
      <input type="number" id="${yearId}_label" value="${defaultYear}" readonly>
    </div>
    <button class="btn" onclick="if(confirm('ç¢ºå®šåˆªé™¤æ­¤å¹´åº¦è³‡æ–™å—ï¼Ÿ')) removeYear('${yearId}')">âŒ åˆªé™¤å¹´åº¦</button>
  </div>
  <div class="table-wrapper"><table><thead><tr><th>æœˆä»½</th>`;
  Object.keys(factors).forEach(f=>{ html+=`<th>${f}</th>`; });
  html+=`<th>ç¸½æ’æ”¾é‡ (å…¬å™¸ COâ‚‚e)</th></tr></thead><tbody>`;
  months.forEach((m,i)=>{
    html+=`<tr><td>${m}</td>`;
    Object.keys(factors).forEach(f=>{
      html+=`<td><input type="number" min="0" step="0.001" value="0" id="${yearId}_${f}_${i}" oninput="validateAndCalc('${yearId}','${f}',${i})"></td>`;
    });
    html+=`<td id="${yearId}_total_${i}" class="result">0.000</td></tr>`;
  });
  html+=`</tbody><tfoot><tr><th colspan="8">å¹´åº¦ç¢³æ’æ”¾é‡(å…¬å™¸ COâ‚‚e)</th><th id="${yearId}_yearTotal" class="result">0.000</th></tr></tfoot></table></div></div>`;

  yearContainer.insertAdjacentHTML("beforeend",html);
  document.getElementById(yearId).scrollIntoView({behavior:'smooth', block:'start'});
  calcAll();
}

function removeYear(id){ 
  const el=document.getElementById(id); 
  if(el) el.remove(); 
  
  const yearBlocks = document.querySelectorAll('.year-block');
  yearBlocks.forEach((block, index) => {
    const newId = `year${index + 1}`;
    const oldId = block.id;

    if (oldId !== newId) {
      // Update block ID
      block.id = newId;

      // Update input and td IDs
      block.querySelectorAll('[id]').forEach(element => {
        if (element.id.startsWith(oldId)) {
          element.id = element.id.replace(oldId, newId);
        }
      });

      // Update oninput attributes
      block.querySelectorAll('[oninput]').forEach(element => {
        let oninputAttr = element.getAttribute('oninput');
        element.setAttribute('oninput', oninputAttr.replace(oldId, newId));
      });

      // Update remove button onclick
      const removeBtn = block.querySelector('.btn[onclick*="removeYear"]');
      if(removeBtn) {
        removeBtn.setAttribute('onclick', `if(confirm('ç¢ºå®šåˆªé™¤æ­¤å¹´åº¦è³‡æ–™å—ï¼Ÿ')) removeYear('${newId}')`);
      }
    }
  });
  calcAll(); 
}

function resetAll(){ document.getElementById("yearContainer").innerHTML=""; if(reductionChart) reductionChart.destroy(); if(energyChart) energyChart.destroy(); document.getElementById("ranking").innerHTML=""; document.getElementById("trend").innerHTML=""; document.getElementById("reduction").innerHTML=""; }

function calcAll(){
  const yearBlocks = Array.from(document.querySelectorAll('.year-block'));
  const years = [];
  const yearTotals = [];
  
  yearBlocks.forEach(block => {
    const yearId = block.id;
    const yearLabel = document.getElementById(`${yearId}_label`).value;
    let yearSum = 0;
    for(let i=0; i<12; i++){
      let total = 0;
      Object.keys(factors).forEach(f=>{
        const val = parseFloat(document.getElementById(`${yearId}_${f}_${i}`).value) || 0;
        total += val * factors[f] / 1000;
      });
      document.getElementById(`${yearId}_total_${i}`).textContent = total.toFixed(3);
      yearSum += total;
    }
    document.getElementById(`${yearId}_yearTotal`).textContent = yearSum.toFixed(3);
    years.push(yearLabel); 
    yearTotals.push(yearSum);
  });

  // Sort the years and totals to ensure correct order
  const sortedData = years.map((y, i) => ({ year: y, total: yearTotals[i] }))
    .sort((a, b) => a.year - b.year);
  const sortedYears = sortedData.map(d => d.year);
  const sortedTotals = sortedData.map(d => d.total);
  
  updateReductionChart(sortedYears, sortedTotals); 
  updateEnergyChart(); 
  updateSummary(sortedYears, sortedTotals);
}

function updateReductionChart(years,yearTotals){
  if(reductionChart) reductionChart.destroy();
  const reductions=[0]; for(let i=1;i<yearTotals.length;i++){ reductions.push(yearTotals[i-1]-yearTotals[i]); }
  reductionChart=new Chart(document.getElementById('reductionChart'),{
    type:'bar',
    data:{
      labels:years,
      datasets:[{label:'å¹´åº¦æ¸›ç¢³é‡(å…¬å™¸ COâ‚‚e)',data:reductions,backgroundColor:reductions.map(v=>v>=0?'#43a047':'#e53935')}]
    },
    options:{
      plugins:{
        legend: { display: false },
        datalabels:{
          display: true,
          anchor:'center',
          align:'center',
          color: '#fff',
          font: { weight: 'bold', size: 12 },
          formatter: (value, context) => {
            if (context.dataIndex === 0) return '';
            return value.toFixed(3);
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    },
    plugins:[ChartDataLabels]
  });
}

function updateEnergyChart(){
  if(energyChart) energyChart.destroy();
  
  const yearBlocks = Array.from(document.querySelectorAll('.year-block'));
  const years = yearBlocks.map(block => document.getElementById(`${block.id}_label`).value).sort((a, b) => a - b);
  
  const datasets = Object.keys(factors).map((f, fIdx) => {
    const data = years.map(year => {
      const block = yearBlocks.find(b => document.getElementById(`${b.id}_label`).value == year);
      if (!block) return 0;
      let sum = 0;
      for(let i=0; i<12; i++){
        sum += parseFloat(document.getElementById(`${block.id}_${f}_${i}`).value) || 0;
      }
      return sum;
    });
    return {
      label: f,
      data: data,
      backgroundColor: baseColors[fIdx]
    };
  });

  energyChart=new Chart(document.getElementById('energyChart'),{
    type:'bar',
    data:{labels:years,datasets:datasets},
    options:{
      plugins:{
        legend: { position: 'bottom' },
        datalabels: {
          display: true,
          color: '#000',
          font: { weight: 'bold', size: 12 },
          formatter: (value) => value > 0 ? value.toFixed(0) : ''
        }
      },
      responsive:true,
      scales:{x:{stacked:true},y:{stacked:true, beginAtZero: true}}
    },
    plugins:[ChartDataLabels]
  });
}

function updateSummary(years,yearTotals){
  let rankingHtml = "<h3>ç¢³æ’æ”¾é‡æ’å</h3><ol>";
  const sorted = years.map((y, i) => ({ year: y, total: yearTotals[i] })).sort((a, b) => b.total - a.total);
  sorted.forEach(e => { rankingHtml += `<li>${e.year}ï¼š${e.total.toFixed(3)} å…¬å™¸ COâ‚‚e</li>`; });
  rankingHtml += "</ol>";
  document.getElementById("ranking").innerHTML = rankingHtml;
  
  let trendHtml = "<h3>ç¢³æ’æ”¾é‡è¶¨å‹¢</h3><ul>";
  years.forEach((y, i) => { trendHtml += `<li>${y}ï¼š${yearTotals[i].toFixed(3)} å…¬å™¸ COâ‚‚e</li>`; });
  trendHtml += "</ul>";
  document.getElementById("trend").innerHTML = trendHtml;
  
  let reductionHtml = "<h3>å¹´åº¦æ¸›ç¢³é‡(èˆ‡å‰ä¸€å¹´åº¦ç›¸è¼ƒ)</h3><ul>";
  for (let i = 0; i < yearTotals.length; i++) {
    if (i == 0) { reductionHtml += `<li>${years[i]}ï¼šåŸºæœŸå¹´</li>`; }
    else {
      const diff = yearTotals[i - 1] - yearTotals[i];
      const icon = diff >= 0 ? `<span class="green-text">ğŸ˜€ è«‹ç¹¼çºŒä¿æŒæ¸›ç¢³</span>` : `<span class="red-text">ğŸ˜¢ è«‹åŠ å¼·èƒ½æºä½¿ç”¨ç®¡ç†ï¼Œè½å¯¦ç¯€èƒ½æ¸›ç¢³</span>`;
      reductionHtml += `<li>${years[i]}ï¼š${diff.toFixed(3)} å…¬å™¸ COâ‚‚e ${icon}</li>`;
    }
  }
  reductionHtml += "</ul>";
  document.getElementById("reduction").innerHTML = reductionHtml;
}

function exportExcel(){
  const wb=XLSX.utils.book_new();
  document.querySelectorAll('.year-block').forEach(block=>{
    const yearId=block.id;
    const hotelName=document.getElementById(`${yearId}_hotel`).value;
    const district=document.getElementById(`${yearId}_district`).value;
    const yearLabel=document.getElementById(`${yearId}_label`).value;
    
    // æ–°å¢ç¬¬ä¸€åˆ—ï¼ŒåŒ…å«æ—…é¤¨åç¨±ã€è¡Œæ”¿å€å’Œå¹´åº¦è³‡è¨Š
    const firstRow = ["æ—…é¤¨åç¨±", hotelName, "è¡Œæ”¿å€", district, "å¹´åº¦", yearLabel];
    
    // èª¿æ•´å¾Œçš„æ¨™é ­åˆ—
    const header=["æœˆä»½",...Object.keys(factors),"æœˆç¸½èƒ½æºä½¿ç”¨é‡","æœˆç¸½æ’æ”¾é‡(å…¬å™¸ COâ‚‚e)"];
    const ws_data=[firstRow, header];
    
    let annualEnergySum=0, annualCO2Sum=0;
    for(let i=0;i<12;i++){
      const row=[months[i]];
      let monthlyEnergy=0, monthlyCO2=0;
      Object.keys(factors).forEach(f=>{
        const val=parseFloat(document.getElementById(`${yearId}_${f}_${i}`).value)||0;
        row.push(val);
        monthlyEnergy+=val;
        monthlyCO2+=val*factors[f]/1000;
      });
      row.push(monthlyEnergy.toFixed(3),monthlyCO2.toFixed(3));
      ws_data.push(row);
      annualEnergySum+=monthlyEnergy; annualCO2Sum+=monthlyCO2;
    }
    const footerRow=["å…¨å¹´ç¸½è¨ˆ"];
    Object.keys(factors).forEach(f=>{
      let total=0; for(let i=0;i<12;i++){ total+=parseFloat(document.getElementById(`${yearId}_${f}_${i}`).value)||0; }
      footerRow.push(total.toFixed(3));
    });
    footerRow.push(annualEnergySum.toFixed(3), annualCO2Sum.toFixed(3));
    ws_data.push(footerRow);
    const ws=XLSX.utils.aoa_to_sheet(ws_data);
    
    // åˆä½µç¬¬ä¸€åˆ—çš„å„²å­˜æ ¼ï¼Œè®“æ¨™é¡Œæ›´ç¾è§€
    ws['!merges'] = [{ s: { r: 0, c: 1 }, e: { r: 0, c: 2 } }, { s: { r: 0, c: 3 }, e: { r: 0, c: 4 } }];
    
    XLSX.utils.book_append_sheet(wb,ws,`å¹´åº¦_${yearLabel}`);
  });
  XLSX.writeFile(wb,"æ—…å®¿èƒ½æºå ±è¡¨.xlsx");
}

function printReport(){ window.print(); }
</script>
</body>
</html>