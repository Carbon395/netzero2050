<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>二氧化碳排放計算器</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
<style>
body { font-family: 'Noto Sans TC', sans-serif; margin: 30px; background: #f4f6f8; color:#2c3e50; }
h2 { color: #2c3e50; margin-bottom: 10px;}
.card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 25px;}
.item { margin: 10px 0; }
input, select { padding: 6px 10px; margin-left: 10px; border:1px solid #ccc; border-radius:6px; }
button { margin:5px 5px 0 0; padding: 10px 18px; border:none; border-radius:8px; cursor:pointer; color:#fff; font-weight:bold; background: linear-gradient(45deg,#3498db,#27ae60); transition:0.3s;}
button:hover { filter: brightness(1.1);}
.result { margin-top: 15px; font-size: 18px; font-weight:bold; color:#e74c3c; }
table { margin-top: 15px; border-collapse: collapse; width: 100%; max-width: 720px; background:#fff; border-radius:8px; overflow:hidden;}
table, th, td { border:1px solid #ddd; }
th, td { padding: 10px; text-align: center; }
th { background:#3498db; color:#fff;}
#chart-container, #yearly-chart, #monthlyChartContainer { margin-top: 25px; max-width: 720px; background:#fff; padding:15px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08);}
</style>
</head>
<body>

<h2>二氧化碳排放計算器</h2>

<div class="card">
  <h3>📅 設定期間</h3>
  <div class="item">
    年度
    <select id="year"></select>
  </div>
  <div class="item">
    期間
    <select id="startMonth"></select> 至
    <select id="endMonth"></select>
  </div>

  <h3>💧 輸入用量 (每月)</h3>
  <div class="item">電力 (度) <input type="number" id="electricity" value="0"></div>
  <div class="item">水 (度) <input type="number" id="water" value="0"></div>
  <div class="item">柴油 (L) <input type="number" id="diesel" value="0"></div>
  <div class="item">車用汽油 (L) <input type="number" id="gasoline" value="0"></div>
  <div class="item">燃料油 (L) <input type="number" id="fuelOil" value="0"></div>
  <div class="item">天然氣 (m³) <input type="number" id="ng" value="0"></div>
  <div class="item">液化石油氣 (L) <input type="number" id="lpg" value="0"></div>

  <button onclick="calculate()">計算排放量</button>
</div>

<div class="card">
  <div class="result" id="result">總排放量：0 KgCO₂e</div>

  <table id="details">
    <thead>
      <tr><th>項目</th><th>用量 (每月)</th><th>排放量 (KgCO₂e)</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="chart-container">
    <canvas id="emissionChart"></canvas>
  </div>
</div>

<div class="card">
  <h3>📊 年度統計</h3>
  <table id="yearlyTable">
    <thead><tr><th>年度</th><th>總排放量 (KgCO₂e)</th></tr></thead>
    <tbody></tbody>
  </table>
  <div id="yearly-chart">
    <canvas id="yearlyChartCanvas"></canvas>
  </div>
  <div class="item">
    選擇年度查看每月排放：
    <select id="selectYear" onchange="renderMonthlyChart()"></select>
  </div>
  <div id="monthlyChartContainer">
    <canvas id="monthlyChartCanvas"></canvas>
  </div>
  <button onclick="exportYearlyExcel()">匯出 Excel (年度)</button>
  <button onclick="exportYearlyPDF()">匯出 PDF (年度)</button>
</div>

<div class="card">
  <button onclick="exportExcel()">匯出 Excel (期間)</button>
  <button onclick="exportPDF()">匯出 PDF (期間)</button>
</div>

<script>
// 初始化年份及月份選單
(function() {
  const yearSelect = document.getElementById("year");
  const selectYear = document.getElementById("selectYear");
  const startMonth = document.getElementById("startMonth");
  const endMonth = document.getElementById("endMonth");
  const currentYear = new Date().getFullYear();
  for(let y=currentYear; y>=currentYear-10; y--){
    let opt=document.createElement("option"); opt.value=y; opt.textContent=y;
    yearSelect.appendChild(opt.cloneNode(true));
    selectYear.appendChild(opt.cloneNode(true));
  }
  yearSelect.value=currentYear;
  selectYear.value=currentYear;

  for(let m=1; m<=12; m++){
    let opt1=document.createElement("option"); opt1.value=m; opt1.textContent=m+" 月";
    let opt2=opt1.cloneNode(true);
    startMonth.appendChild(opt1);
    endMonth.appendChild(opt2);
  }
  startMonth.value=1;
  endMonth.value=12;
})();

// CO2 排放係數
const emissionFactors = {
  electricity: 0.474,
  water: 0.156,
  diesel: 2.606,
  gasoline: 2.263,
  fuelOil: 3.111,
  ng:1.879,
  lpg:1.753
};

let history = []; // 保存所有計算紀錄

function calculate() {
  const year = parseInt(document.getElementById("year").value);
  const startMonth = parseInt(document.getElementById("startMonth").value);
  const endMonth = parseInt(document.getElementById("endMonth").value);

  const data = {
    electricity: parseFloat(document.getElementById("electricity").value) || 0,
    water: parseFloat(document.getElementById("water").value) || 0,
    diesel: parseFloat(document.getElementById("diesel").value) || 0,
    gasoline: parseFloat(document.getElementById("gasoline").value) || 0,
    fuelOil: parseFloat(document.getElementById("fuelOil").value) || 0,
    ng: parseFloat(document.getElementById("ng").value) || 0,
    lpg: parseFloat(document.getElementById("lpg").value) || 0
  };

  const detailsTbody = document.querySelector("#details tbody");
  detailsTbody.innerHTML = "";
  let monthlyTotal = 0;
  for(let key in data){
    let emission = data[key] * emissionFactors[key];
    monthlyTotal += emission;
    let tr=document.createElement("tr");
    tr.innerHTML=`<td>${key}</td><td>${data[key]}</td><td>${emission.toFixed(2)}</td>`;
    detailsTbody.appendChild(tr);
  }

  const total = monthlyTotal * (endMonth - startMonth + 1);
  document.getElementById("result").textContent = `總排放量：${total.toFixed(2)} KgCO₂e`;

  // 保存歷史資料 (可累積)
  history.push({ year, startMonth, endMonth, data, total });

  updateYearlyData();
  renderChart(data);
  renderMonthlyChart();
}

// 單月圖表
function renderChart(data) {
  const ctx=document.getElementById("emissionChart").getContext("2d");
  if(window.emissionChart) window.emissionChart.destroy();
  window.emissionChart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:Object.keys(data),
      datasets:[{ label:"排放量 KgCO₂e", data:Object.keys(data).map(k=> (data[k]*emissionFactors[k]).toFixed(2)), backgroundColor:"#3498db"}]
    },
    options:{responsive:true}
  });
}

// 年度統計
function updateYearlyData(){
  const yearly = {};
  history.forEach(h=>{
    if(!yearly[h.year]) yearly[h.year]=0;
    yearly[h.year]+=h.total;
  });

  const tbody=document.querySelector("#yearlyTable tbody");
  tbody.innerHTML="";
  Object.keys(yearly).sort().forEach(y=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${y}</td><td>${yearly[y].toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });

  // 更新年度下拉
  const selectYear = document.getElementById("selectYear");
  const years = Object.keys(yearly).sort((a,b)=>b-a);
  selectYear.innerHTML="";
  years.forEach(y=>{
    let opt=document.createElement("option"); opt.value=y; opt.textContent=y;
    selectYear.appendChild(opt);
  });
  selectYear.value=years[0];

  // 年度圖表
  const ctx=document.getElementById("yearlyChartCanvas").getContext("2d");
  if(window.yearlyChart) window.yearlyChart.destroy();
  window.yearlyChart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:Object.keys(yearly).sort(),
      datasets:[{label:"年度總排放量 KgCO₂e", data:Object.keys(yearly).sort().map(y=>yearly[y].toFixed(2)), backgroundColor:"#f39c12"}]
    },
    options:{responsive:true}
  });
}

// 每月圖表
function renderMonthlyChart(){
  const selectedYear = parseInt(document.getElementById("selectYear").value);
  const monthly = Array(12).fill(0);
  history.filter(h=>h.year==selectedYear).forEach(h=>{
    const monthsCount = h.endMonth - h.startMonth +1;
    for(let m=h.startMonth-1; m<=h.endMonth-1; m++){
      monthly[m] += h.total/monthsCount;
    }
  });

  const ctx=document.getElementById("monthlyChartCanvas").getContext("2d");
  if(window.monthlyChart) window.monthlyChart.destroy();
  window.monthlyChart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],
      datasets:[{label:selectedYear+"年度每月排放量 KgCO₂e", data:monthly.map(v=>v.toFixed(2)), backgroundColor:"#9b59b6"}]
    },
    options:{responsive:true}
  });
}

// 匯出期間 Excel/PDF
function exportExcel(){
  const wb=XLSX.utils.book_new();
  const ws_data=[["項目","用量 (每月)","排放量(KgCO₂e)"]];
  document.querySelectorAll("#details tbody tr").forEach(tr=>{
    ws_data.push(Array.from(tr.children).map(td=>td.textContent));
  });
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"期間排放");
  XLSX.writeFile(wb,"CO2期間排放.xlsx");
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  doc.text("期間 CO2 排放明細",14,20);
  doc.autoTable({html:"#details",startY:30});
  doc.save("CO2期間排放.pdf");
}

// 匯出年度 Excel/PDF
function exportYearlyExcel(){
  const wb=XLSX.utils.book_new();
  const ws_data=[["年度","總排放量(KgCO2e)"]];
  document.querySelectorAll("#yearlyTable tbody tr").forEach(tr=>{
    ws_data.push(Array.from(tr.children).map(td=>td.textContent));
  });
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"年度統計");
  XLSX.writeFile(wb,"CO2年度統計.xlsx");
}

function exportYearlyPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("年度 CO2 排放統計", 14, 20);
  doc.autoTable({ html: "#yearlyTable", startY: 30 });
  doc.save("CO2年度統計.pdf");
}
</script>
</body>
</html>
